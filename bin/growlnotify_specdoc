#!/usr/bin/env ruby -w

class GrowlNotifySpecdoc

  def initialize(args)
    print_help if args.empty?
    @specdoc_file = args[0]
    @spec_title = args[1] || 'spec'
    @output = collect_output
    @result = parse_result
  end

  def print_help
    puts <<-HELP
Usage: growlnotify_specdoc [SPECDOC] [TITLE]

HELP
    exit
  end

  def run
    system "growlnotify -n autotest --image #{image} -m \"#{@output.split("\n").last}\" #{title}"
  end

private 

  def collect_output
    fh = File.new(@specdoc_file)
    fh.read
  end

  def parse_result
    if @output =~ /[1-9]\sfailures?/ || @output =~ /errors/
      "red"
    elsif @output =~ /pending/
      "pending"
    else
      "green"
    end
  end
  
  def image
    File.join(File.dirname(__FILE__), 'img', "#{@result}.png")
  end

  def title
    res = ''
    res << case @result
    when 'red'; "Fail: "
    when 'pending'; "Pending: "
    else; "Pass: "
    end
    res << @spec_title
  end

end

GrowlNotifySpecdoc.new($*).run

